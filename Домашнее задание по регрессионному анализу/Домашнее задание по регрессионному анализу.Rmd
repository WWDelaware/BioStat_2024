---
title: "Домашнее задание по регрессионному анализу"
author: "Sergey"
date: "2025-01-17"
output: html_document
---

```{r setup, include=FALSE}
# Установка библиотек
library("tidyverse")
library("broom")
library("car")
library("performance")
library("ggplot2")
library("readxl")
library("lmtest")
library("modelsummary")
library("GGally")
library("flextable")
library("gt")
library("ggfortify")
```

```{r, include=FALSE}
# Загрузка данных
# Файлы должны быть в рабочей директории
codebook <- readxl::read_excel("HW_codebook.xlsx", sheet = NULL)
data <- readxl::read_excel("HW_data.xlsx", sheet = "Sheet1")
```

```{r, include=FALSE}
# Предварительная обработка данных
# Создание переменной Total_PA_Minutes (суммарная физическая активность)
data <- data %>% 
  mutate(
    Total_PA_Minutes = PAD615 + PAD630 + PAD645 + PAD660 + PAD675,
    PAD680_cleaned = ifelse(PAD680 < 5000, PAD680, NA) # Очистка выбросов
  )

# Преобразование категориальных переменных PAQ в факторы
paq_columns <- names(data)[grep("^PAQ", names(data))]
data <- data %>% mutate(across(all_of(paq_columns), as.factor))
```

# Анализ распределений
## Распределение гликированного гемоглобина (HbA1c)

```{r, include=FALSE}
ggplot(data, aes(x = LBXGH)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7, color = "black") +
  labs(title = "Распределение HbA1c", x = "HbA1c (%)", y = "Частота")
```

# Корреляционный анализ

```{r, include=FALSE}
cor_matrix <- data %>% 
  select(LBXGH, Total_PA_Minutes, PAD680_cleaned) %>% 
  cor(use = "pairwise.complete.obs", method = "spearman")

print("Матрица корреляций:")
print(cor_matrix)
```

# Определяем зависимую и независимые переменные

```{r, include=FALSE}
# Убедимся, что данные синхронизированы
X <- data %>% 
  select(LBXGH, Total_PA_Minutes, PAD680_cleaned) %>% 
  drop_na()  # Удаляем строки с пропущенными значениями

y <- X$LBXGH  # Зависимая переменная
X <- X %>% select(-LBXGH)  # Независимые переменные
```

# Построение модели

```{r, include=FALSE}
model <- lm(y ~ Total_PA_Minutes + PAD680_cleaned, data = X)
```

# Оценка модели

```{r}
summary_model <- summary(model)
print(summary_model)
```

# Диагностика модели
```{r}
residuals <- residuals(model)
```

# Тест Шапиро-Уилка на нормальность остатков

```{r}
shapiro_test <- shapiro.test(residuals)
print(shapiro_test)
```

# Тест Бреуша-Пагана на гетероскедастичность

```{r}
bp_test <- bptest(model)
print(bp_test)
```

# Multicollinearity (VIF)

```{r}
vif_values <- vif(model)
print("VIF Values:")
print(vif_values)
```

# Графическая диагностика
## График остатков
```{r}
autoplot(model, which = 1) + labs(title = "График остатков")
```

# Улучшение модели (добавление ковариат)
## Добавляем ковариаты: возраст (RIDAGEYR) и пол (RIAGENDR)

```{r}
X_extended <- data %>% 
  select(LBXGH, Total_PA_Minutes, PAD680_cleaned, RIDAGEYR, RIAGENDR) %>% 
  mutate(RIAGENDR = as.factor(RIAGENDR)) %>% 
  drop_na()
model_extended <- lm(LBXGH ~ Total_PA_Minutes + PAD680_cleaned + RIDAGEYR + RIAGENDR, data = X_extended)
```

# Оценка новой модели

```{r}
summary_extended <- summary(model_extended)
print(summary_extended)
```

# Диагностика новой модели

```{r}
residuals_extended <- residuals(model_extended)
shapiro_test_extended <- shapiro.test(residuals_extended)
print(shapiro_test_extended)

bp_test_extended <- bptest(model_extended)
print(bp_test_extended)

vif_values_extended <- vif(model_extended)
print("VIF Values (Extended Model):")
print(vif_values_extended)
```

# 9. Финальный вывод

```{r}
print("Сравнение базовой и расширенной моделей")
print(glance(model))
print(glance(model_extended))
```


