---
title: "Домашнее задание по регрессионному анализу"
author: "Sergey"
date: "2025-01-17"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
# Установка библиотек
library("tidyverse")
library("broom")
library("car")
library("gtsummary")
library("dagitty")
library("ggdag")
library("performance")
library("ggplot2")
library("readxl")
library("lmtest")
library("ggResidpanel")
library("modelsummary")
library("performance")
library("GGally")
library("flextable")
library("gt")
library("ggfortify")
library("sandwich")
library("emmeans")
library("kableExtra")
```

```{r, include=FALSE}
# Загрузка данных и перевод в факторные величины
data <- readxl::read_excel("HW_data.xlsx", sheet = "Sheet1") %>% 
  mutate(across(c(RIAGENDR, RIDRETH3, DMDEDUC2, DMDMARTL, DRQSDIET, DRQSDT1, DRQSDT2, DRQSDT3, DRQSDT4, DRQSDT7, DRQSDT8, DRQSDT9, DRQSDT10, DRQSDT91, DRD340, DRD360, ALQ101, ALQ120U, SMQ020, SMQ040, PAQ605, PAQ620, PAQ635, PAQ650, PAQ665, MCQ010, MCQ035, MCQ160C, MCQ160B, MCQ160E, MCQ160F, MCQ160M, MCQ160O, MCQ220, BPQ020, DIQ010, SMQ040), as.factor))
#head(data)
#str(data)
#data %>% skimr::skim()
#data %>% dplyr::select(INDFMIN2)
```

# Направленный ациклический граф (DAG)

DAG демонстрирует, какие роли, с точки зрения причинно-следственного
вывода, в нем играют разные показатели и как его использовать для отбора
комвариат.

```{r, include=FALSE}
dag_model <- dagitty('
dag {
bb="0,0,1,1"
"Blood pressure" [pos="0.489,0.460"]
"Body mass index (BMI)" [pos="0.490,0.174"]
"Diabetic medication" [pos="0.548,0.540"]
"Family income" [pos="0.163,0.324"]
"Glycated hemoglobin (HbA1c)" [outcome,pos="0.548,0.327"]
"Marital status" [pos="0.161,0.238"]
"Physical activity" [exposure,pos="0.334,0.287"]
Age [pos="0.229,0.509"]
Comorbidities [pos="0.354,0.542"]
Education [pos="0.254,0.170"]
Race [pos="0.361,0.172"]
Sex [pos="0.311,0.460"]
Smoking [pos="0.196,0.397"]
"Body mass index (BMI)" -> "Blood pressure"
"Body mass index (BMI)" -> "Glycated hemoglobin (HbA1c)"
"Family income" -> "Physical activity"
"Family income" -> Smoking
"Glycated hemoglobin (HbA1c)" -> "Blood pressure"
"Glycated hemoglobin (HbA1c)" -> "Diabetic medication"
"Marital status" -> "Physical activity"
"Physical activity" -> "Blood pressure"
"Physical activity" -> "Body mass index (BMI)"
"Physical activity" -> "Glycated hemoglobin (HbA1c)"
Age -> "Blood pressure"
Age -> "Physical activity"
Age -> Comorbidities
Comorbidities -> "Blood pressure"
Comorbidities -> "Diabetic medication"
Comorbidities -> "Glycated hemoglobin (HbA1c)"
Comorbidities -> "Physical activity"
Education -> "Family income"
Education -> "Physical activity"
Education -> Smoking
Race -> "Family income"
Race -> "Glycated hemoglobin (HbA1c)"
Race -> "Physical activity"
Race -> Education
Sex -> "Blood pressure"
Sex -> "Glycated hemoglobin (HbA1c)"
Sex -> "Physical activity"
Sex -> Smoking
Smoking -> "Blood pressure"
Smoking -> "Glycated hemoglobin (HbA1c)"
Smoking -> Comorbidities
}
')

# Визуализируем DAG 
plot(dag_model)

# Получаем наборы для корректировки (минимальные)
adjust_sets <- adjustmentSets(dag_model, type = "minimal")
cat("\nМинимальные наборы для корректировки (DAGitty):\n")
print(adjust_sets)
```

# Задание 1

Каким образом вы будете оценивать физическую активность респондентов?
Есть ли у вас предварительные предположения относительно того, каким
образом выбранный вами показатель может быть ассоциирован с
гликированным гемоглобином?

Пояснение: Физическую активность будем оценивать по переменным,
отражающим физическую активность респондентов: 1) PAQ605 - Vigorous work
activity 2) PAQ610 - Number of days vigorous work 3) PAD615 - Minutes
vigorous-intensity work

4)  PAQ620 - Moderate work activity
5)  PAQ625 - Number of days moderate work
6)  PAD630 - Minutes moderate-intensity work

7)  PAQ635 - Walk or bicycle
8)  PAQ640 - Number of days walk or bicycle
9)  PAD645 - Minutes walk/bicycle for transportation

10) PAQ650 - Vigorous recreational activities
11) PAQ655 - Days vigorous recreational activities
12) PAD660 - Minutes vigorous recreational activities

13) PAQ665 - Moderate recreational activities
14) PAQ670 - Days moderate recreational activities
15) PAD675 - Minutes moderate recreational activities

16) PAD680 - Minutes sedentary activity

Для создания более проработанной системы рейтинга физической активности,
которая сводит все переменные к одной итоговой метрике, можно
использовать подход, основанный на метаболическом эквиваленте (MET). MET
— это единица, которая отражает энергетические затраты различных видов
физической активности относительно состояния покоя. Это позволит более
точно учесть интенсивность и тип активности, а также минимизировать
субъективность в расчетах:

Создадим систему рейтинга с присвоение MET для каждого типа активности:
1) Vigorous work/recreational activities: 6 MET (высокая интенсивность);
2) Moderate work/recreational activities: 3.5 MET (умеренная
интенсивность); 3) Walk or bicycle: 4 MET (ходьба или езда на
велосипеде); 4) Sedentary activity: 1 MET (сидячая активность, состояние
покоя).

Для каждого типа активности будем рассчитывать MET-минуты по формуле:

**MET-минуты = Количество дней (PAQ625, PAQ640, PAQ655, PAQ670) × Минуты в день (PAD630, PAD645, PAD660, PAD675) × MET**

Например, для Vigorous work: PAQ610 × PAD615 × 6

Учет сидячей активности:
Сидячая активность вычитается из общего объема активности, так как она снижает общий уровень физической активности:

**Sedentary MET-минуты = 7 × PAD680 × 1**

Это значение вычитается из общей суммы MET-минут.

Итоговая формула:

**total_PA=(PAQ610×PAD615×6)+(PAQ625×PAD630×3.5)+(PAQ640×PAD645×4)+(PAQ655×PAD660×6)+(PAQ670×PAD675×3.5)−(7×PAD680×1)**

Предварительные предположения относительно того, каким образом выбранный вами показатель может быть ассоциирован с гликированным гемоглобином: чем больше физическая активность, тем меньше гликированного гемоглобина.

# Задание 2

Ковариаты для каких показателей вы включите в модель для коррекции эффекта физической активности в отношении гликированного гемоглобина? Каким образом вы будете их оценивать по имеющимся данным?

Пояснение: Согласно представленному DAG-у и указанным минимальным достаточным наборам для коррекции (adjustment sets), необходимо включить в модель регрессии переменные, которые блокируют все biasing paths между физической активностью (exposure) и гликированным гемоглобином (outcome). Минимально достаточные наборы корректировок для оценки общего влияния физической активности на гликированный гемоглобин (HbA1c): 

1) Age, Comorbidities, Education, Family income, Race, Sex
2) Comorbidities, Race, Sex, Smoking

Возьмём первый набор корректировок: Age, Comorbidities, Education, Family income, Race, Sex, Smoking являются конфаундерам и должны быть скорректированы (включены в модель регрессии вместе с показателем физической активности). Для каждой из представленных конфаундеров будем использовать следующие переменные (исходя из HW_codebook.xlsx):

1) Age (Возраст) - RIDAGEYR - Age in years at screening;
2) Comorbidities (Сопутсвующие заболевания) - категориальная переменная, которая принимает значение yes, если любая из переменных (из раздела questionnaire):
MCQ010 (Ever been told you have asthma),
MCQ035 (Have asthma),
MCQ160c (Ever told you had coronary heart disease),
MCQ160b (Ever told had congestive heart failure),
MCQ160e (Ever told you had heart attack),
MCQ160f (Ever told you had a stroke),
MCQ160m (Ever told you had thyroid problem),
MCQ160o (Ever told you had COPD?),
MCQ220 (Ever told you had cancer or malignancy),
BPQ020 (Ever told you had high blood pressure),
DIQ010 (Doctor told you have diabetes)
имеет значение 1 (Yes), и принимает no, если все указанные переменные имеют значение 2 (No). Переменные типа DIQ070 (Take diabetic pills to lower blood sugar) не учитываются, так как ответ на них будет явлется следствием уже включённое переменной;
3) Education (Уровень образования) - DMDEDUC2 - Education level - Adults 20+ (5 уровней);
4) Family income (Годовой доход семьи) - будем использовать переменную INDFMIN2 (INDFMIN2 - Annual family income);
5) Race (Раса) - RIDRETH3 - Race/Hispanic origin w/ NH Asian;
6) Sex (Пол) - RIAGENDR - Gender;
7) Smoking - SMQ020 - Smoked at least 100 cigarettes in life.

# Бонусное задание:

Для представленного DAG'а укажите роль каждого показателя по отно-
шению к изучаемой ассоциации между физической активностью и гликированным гемогло-
бином (конфаундеры (в том числе proxy конфаундеры), коллайдеры, медиаторы)

Пояснение:
Конфаундеры (переменные, которые влияют как на exposure (физическая активность), так и на outcome (гликированный гемоглобин). Они должны быть скорректированы в анализе): Age, Comorbidities, Education, Family income, Race, Sex, Smoking;
Proxy-конфаундеры (Proxy-конфаундеры — это переменные, которые сами не являются конфаундерами, но коррелируют с ними и могут использоваться для их коррекции): Marital status;
Коллайдеры (переменные, которые находятся на причинном пути между exposure и outcome): Body mass index (BMI), Blood pressure, Diabetic medication;
Медиаторы (переменные, которые находятся на причинном пути между exposure и outcome): Body mass index (BMI, Physical activity → BMI → HbA1c), Blood pressure (Physical activity → Blood pressure → HbA1c).

# Задание 3

Проведите необходимый эксплораторный анализ перед оценкой модели.

```{r}
# Подготовка данных
modified_data <- data %>% 
  mutate(
    gHg = LBXGH,
    total_PA = (PAQ610 * PAD615 * 6) + (PAQ625 * PAD630 * 3.5) + 
               (PAQ640 * PAD645 * 4) + (PAQ655 * PAD660 * 6) + 
               (PAQ670 * PAD675 * 3.5) - (7 * PAD680 * 1),
    PA_category = case_when(
      total_PA < 500 ~ "Low",
      total_PA >= 500 & total_PA < 1000 ~ "Moderate",
      total_PA >= 1000 ~ "High"
    ),
    Age = RIDAGEYR,
    Comorbidities = as.factor(ifelse(MCQ010 == 1 | MCQ035 == 1 | MCQ160C == 1 | MCQ160B == 1 | 
                                     MCQ160E == 1 | MCQ160F == 1 | MCQ160M == 1 | MCQ160O == 1 | 
                                     MCQ220 == 1 | BPQ020 == 1 | DIQ010 == 1, "yes", "no")),
    Education = as.factor(DMDEDUC2),
    Family_income = as.factor(INDFMIN2),
    Race = as.factor(RIDRETH3),
    Sex = as.factor(ifelse(RIAGENDR == 1, "Male", "Female")),
    Smoking = as.factor(SMQ040)
  ) %>%
  dplyr::select(SEQN, gHg, total_PA, PA_category, Age, Comorbidities, Education, Family_income, Race, Sex, Smoking)

# Описательная статистика
tbl_summary(
  modified_data, 
  include = -c(SEQN, total_PA), 
  type = list(all_continuous() ~ "continuous2"),
  statistic = list(
    all_continuous() ~ c("{N_nonmiss}", "{mean} ({sd})", "{median} ({p25}-{p75})", "{min}-{max}")
  )
) %>%
  modify_footnote(everything() ~ NA) %>%
  bold_labels()

# Визуализация зависимости HbA1c от физической активности
ggplot(modified_data, aes(x = total_PA, y = gHg)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = "Total Physical Activity (MET-min/week)", y = "HbA1c (%)", 
       title = "Scatter plot of HbA1c vs Physical Activity")

# Распределение HbA1c по уровням активности
ggplot(modified_data, aes(x = PA_category, y = gHg, fill = PA_category)) +
  geom_boxplot() +
  labs(x = "Physical Activity Level", y = "HbA1c (%)", 
       title = "HbA1c by Physical Activity Level")

# Распределение ковариат по уровням активности
tbl_summary(
  modified_data,
  by = PA_category,
  include = c(Age, Comorbidities, Education, Family_income, Race, Sex, Smoking),
  type = list(all_continuous() ~ "continuous2"),
  statistic = list(
    all_continuous() ~ c("{mean} ({sd})", "{median} ({p25}-{p75})")
  )
) %>%
  modify_footnote(everything() ~ NA) %>%
  bold_labels()
```
```{r, fig.width=13, fig.height=13}
ggpairs(
  modified_data %>% dplyr::select(gHg, total_PA, Age, Comorbidities, Education, Family_income, Race, Sex, Smoking),
  upper = list(
    continuous = wrap("points", alpha = 0.5, size = 1, color = "#1F78B4"),  # Изменение цвета точек
    combo = wrap("points", alpha = 0.5, size = 1, color = "#1F78B4"),       # Цвет для комбинированных графиков
    discrete = "blank"  # Пустые графики для дискретных переменных
  ),
  lower = list(
    continuous = wrap("cor", size = 4, color = "black", method = "pearson"),  # Корреляции с улучшенным оформлением
    discrete = wrap("count", fill = "#A6CEE3", color = "black"),              # Гистограммы для дискретных переменных
    combo = wrap("box_no_facet", outlier.size = 0.5, fill = "#A6CEE3", color = "black")  # Ящики с усами
  ),
  diag = list(
    continuous = wrap("densityDiag", fill = "#1F78B4", alpha = 0.5),  # Плотность распределения для непрерывных переменных
    discrete = wrap("barDiag", fill = "#A6CEE3", color = "black")     # Столбчатые диаграммы для дискретных переменных
  ),
  showStrips = TRUE,  # Отображение подписей
  progress = FALSE    # Отключение индикатора прогресса
) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  # Наклон подписей оси X
    axis.text.y = element_text(size = 8),                         # Размер подписей оси Y
    panel.grid.minor = element_blank(),                           # Удаление второстепенных линий сетки
    strip.placement = "outside",                                  # Размещение подписей снаружи
    strip.background = element_rect(color = "white", fill = "#EFEBE9"),  # Цвет фона подписей
    strip.text = element_text(size = 10, face = "bold")           # Оформление подписей
  )
```

В следущих графиках наглядно видны выбросы: 
1) total_PA против gHg;
2) Age, Comorbidities, Education, Family income, Race, Sex, Smoking против Total PA.

```{r, fig.width=13, fig.height=13}
# Функция для идентификации выбросов (только для числовых переменных)
identify_outliers <- function(data, column) {
  if (is.numeric(data[[column]])) {  # Проверяем, является ли переменная числовой
    Q1 <- quantile(data[[column]], 0.25, na.rm = TRUE)
    Q3 <- quantile(data[[column]], 0.75, na.rm = TRUE)
    IQR <- Q3 - Q1
    lower_bound <- Q1 - 1.5 * IQR
    upper_bound <- Q3 + 1.5 * IQR
    data[[column]] < lower_bound | data[[column]] > upper_bound
  } else {
    rep(FALSE, nrow(data))  # Для нечисловых переменных возвращаем FALSE (не считаем выбросами)
  }
}

# Идентификация выбросов только для числовых переменных
cleaned_data <- modified_data %>%
  mutate(
    outlier_total_PA = identify_outliers(modified_data, "total_PA"),
    outlier_gHg = identify_outliers(modified_data, "gHg"),
    outlier_Age = identify_outliers(modified_data, "Age"),
    outlier_Family_income = identify_outliers(modified_data, "Family_income")
    # Категориальные переменные (Comorbidities, Education, Race, Sex, Smoking) исключены
  )

# Создание флага для строк с выбросами
cleaned_data <- cleaned_data %>%
  mutate(
    is_outlier = outlier_total_PA | outlier_gHg | outlier_Age | outlier_Family_income
  )

# Разделение данных на основной датасет и датасет с выбросами
main_data <- cleaned_data %>% filter(!is_outlier) %>% dplyr::select(-contains("outlier"))
outliers_data <- cleaned_data %>% filter(is_outlier) %>% dplyr::select(-contains("outlier"))

#head(main_data)
#head(outliers_data)

ggpairs(
  main_data %>% dplyr::select(gHg, total_PA, Age, Comorbidities, Education, Family_income, Race, Sex, Smoking),
  upper = list(
    continuous = wrap("points", alpha = 0.5, size = 1, color = "#1F78B4"),  # Изменение цвета точек
    combo = wrap("points", alpha = 0.5, size = 1, color = "#1F78B4"),       # Цвет для комбинированных графиков
    discrete = "blank"  # Пустые графики для дискретных переменных
  ),
  lower = list(
    continuous = wrap("cor", size = 4, color = "black", method = "pearson"),  # Корреляции с улучшенным оформлением
    discrete = wrap("count", fill = "#A6CEE3", color = "black"),              # Гистограммы для дискретных переменных
    combo = wrap("box_no_facet", outlier.size = 0.5, fill = "#A6CEE3", color = "black")  # Ящики с усами
  ),
  diag = list(
    continuous = wrap("densityDiag", fill = "#1F78B4", alpha = 0.5),  # Плотность распределения для непрерывных переменных
    discrete = wrap("barDiag", fill = "#A6CEE3", color = "black")     # Столбчатые диаграммы для дискретных переменных
  ),
  showStrips = TRUE,  # Отображение подписей
  progress = FALSE    # Отключение индикатора прогресса
) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, size = 8),  # Наклон подписей оси X
    axis.text.y = element_text(size = 8),                         # Размер подписей оси Y
    panel.grid.minor = element_blank(),                           # Удаление второстепенных линий сетки
    strip.placement = "outside",                                  # Размещение подписей снаружи
    strip.background = element_rect(color = "white", fill = "#EFEBE9"),  # Цвет фона подписей
    strip.text = element_text(size = 10, face = "bold")           # Оформление подписей
  )
```

"Исправилось" распределние gHg и total_PA. Явных выбрососов в упомянутых переменных нет.
Рассмотрим график с для "Визуализации зависимости HbA1c от физической активности":

```{r}
ggplot(main_data, aes(x = total_PA, y = gHg)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", color = "red") +
  labs(x = "Total Physical Activity (MET-min/week)", y = "HbA1c (%)", 
       title = "Scatter plot of HbA1c vs Physical Activity")
```

Явные выбросы были удалены. Работаем с датасетом main_data. Наблюдается неравномерный разброс H1bA1c (%) от Total Physical Activity (MET-min/week) по мере увеличения перменной для общей физ активнсоти. Чем она больше, тем разброс меньше: у нуля наиболший разброс по шкале процентов гликированный гемоглобина.

# Задание 4

Оцените модель для зависимости гликированного гемоглобина от выбранного вами показателя физической активности без ковариат и с ними. Проведите необходимую диагностику этих моделей -- требует ли что-либо коррекции и почему? В случае необходимости коррекции по результатам диагностики сделайте ее.

## Оцените модель для зависимости гликированного гемоглобина от МЕТ-min/week без ковариат. Диагностика, визуализация остатков, проверка гетероскедастичности, коррекция.

```{r, fig.width=15, fig.height=15}
# Модель без ковариат
model_without_covariates <- lm(gHg ~ total_PA, data = main_data)
summary(model_without_covariates)
confint(model_without_covariates)

# Диагностика модели
performance::check_model(model_without_covariates)

# Визуализация остатков
ggResidpanel::resid_panel(model_without_covariates, plots = c("resid", "qq", "hist", "cookd"))

# Проверка гетероскедастичности
lmtest::bptest(model_without_covariates)

# Коррекция гетероскедастичности с помощью робастных стандартных ошибок
coeftest(model_without_covariates, vcov = vcovHC(model_without_covariates, type = "HC1"))
```

Интерпретация:

1) Posterior Predictive Check (Проверка предсказательной мощности модели):

Линия, соответствующая предсказанным данным, хорошо совпадает с линией наблюдаемых данных. Это говорит о том, что модель хорошо описывает распределение целевой переменной.

2) Linearity (Линейность):

Остатки распределены вокруг горизонтальной линии на уровне нуля. Однако видны небольшие отклонения, которые могут указывать на нарушение предположения о линейности.

3) Homogeneity of Variance (Гомогенность дисперсии):

Остатки распределены неравномерно: можно заметить небольшую тенденцию к увеличению дисперсии с ростом значений предсказанных значений. Это указывает на возможную гетероскедастичность.

4) Influential Observations (Влияние наблюдений):

Большинство точек находятся внутри контрольных линий. Однако несколько точек выделяются как потенциально влиятельные наблюдения, что может повлиять на стабильность модели.

5) Normality of Residuals (Нормальность остатков):

Точки на графике QQ-Plot отклоняются от диагональной линии в правой части, что свидетельствует о легкой асимметрии остатков или выбросах.

6) Residual Plot (График остатков):

Остатки распределены вокруг горизонтальной линии 𝑦= 0. Однако видна определенная структура (веерообразный рисунок), что указывает на наличие гетероскедастичности — дисперсия остатков увеличивается с ростом предсказанных значений. Это нарушение предположения о равенстве дисперсий (гомоскедастичности).

7) Q-Q Plot (График квантилей-квантилей):

Точки в основном располагаются вдоль диагональной линии, за исключением концов распределения. Это указывает на то, что остатки близки к нормальному распределению, хотя в хвостах имеются отклонения (возможны выбросы).

8) Histogram (Гистограмма остатков):

Распределение остатков симметрично и похоже на нормальное, хотя наблюдаются легкие отклонения в хвостах. Это согласуется с наблюдением на Q-Q Plot.

9) Cook's D Plot (График значений D Кука):

Большинство точек имеют низкие значения𝐷, однако несколько точек превышают стандартный порог (обычно 𝐷> 0.5 считается значимым). Эти точки могут быть потенциально влиятельными наблюдениями, которые существенно влияют на параметры модели.

Выводы:

1) Возможная нелинейность: Возможны незначительные отклонения, требующие проверки. Может быть полезным добавить нелинейные термины или провести преобразование предиктора.
2) Гетероскедастичность: Есть признаки увеличения дисперсии остатков. Можно рассмотреть использование робастных стандартных ошибок или провести преобразование gHg.
3) Возможны выбросы.

## Оцените модель для зависимости гликированного гемоглобина от МЕТ-min/week с ковариатами. Диагностика, визуализация остатков, проверка гетероскедастичности, коррекция.

```{r, fig.width=15, fig.height=15}
# Модель с ковариатами
model_with_covariates <- lm(gHg ~ total_PA + Age + Comorbidities + Education + Family_income + Race + Sex + Smoking, data = main_data)
summary(model_with_covariates)
confint(model_with_covariates)

# Диагностика модели
performance::check_model(model_with_covariates)

# Визуализация остатков
ggResidpanel::resid_panel(model_with_covariates, plots = c("resid", "qq", "hist", "cookd"))

# Проверка гетероскедастичности
lmtest::bptest(model_with_covariates)

# Коррекция гетероскедастичности с помощью робастных стандартных ошибок
coeftest(model_with_covariates, vcov = vcovHC(model_with_covariates, type = "HC1"))

# Проверка мультиколлинеарности
car::vif(model_with_covariates)
```

Интерпретация: 

1) Posterior Predictive Check (Проверка предсказательной мощности модели):

Линия, соответствующая предсказанным данным, хорошо совпадает с линией наблюдаемых данных. Это говорит о том, что модель хорошо описывает распределение целевой переменной.

2) Linearity (Линейность):

Остатки распределены вокруг горизонтальной линии на уровне нуля. Однако видны небольшие отклонения, которые могут указывать на нарушение предположения о линейности.

3) Homogeneity of Variance (Гомогенность дисперсии):

Остатки распределены неравномерно: можно заметить небольшую тенденцию к увеличению дисперсии с ростом значений предсказанных значений. Это указывает на возможную гетероскедастичность.

4) Influential Observations (Влияние наблюдений):

Большинство точек находятся внутри контрольных линий. Однако несколько точек выделяются как потенциально влиятельные наблюдения, что может повлиять на стабильность модели.

5) Normality of Residuals (Нормальность остатков):

Точки на графике QQ-Plot отклоняются от диагональной линии в правой части, что свидетельствует о легкой асимметрии остатков или выбросах.

6) Residual Plot (График остатков):

Остатки распределены равномерно вокруг нуля без явной структуры. Однако видна слабая эллиптическая форма, что может указывать на остаточную нелинейность. Гомогенность дисперсии (гетероскедастичность) нарушена слабо, явных веерообразных форм не наблюдается.

7) Q-Q Plot (График квантиль-квантиль):
Остатки близки к линии нормального распределения, особенно в центральной части.
В хвостах (в области экстремальных значений) наблюдаются отклонения. Это может быть связано с выбросами или незначительными нарушениями нормальности.

8) Histogram (Гистограмма остатков):

Распределение остатков близко к нормальному (колоколообразная форма). Небольшие отклонения наблюдаются в хвостах распределения, но они незначительны.

9) Cook's D Plot (График влияния наблюдений):

Большинство точек имеют низкие значения 𝐷 Кука, что говорит о слабом влиянии отдельных наблюдений. Однако несколько точек находятся выше порогового значения, что свидетельствует о потенциально влияющих наблюдениях, требующих анализа.

10) Collinearity (Коллинеарность):

Все переменные имеют низкие значения VIF (< 5), что указывает на отсутствие проблем с мультиколлинеарностью.

### Вывод

Модель в целом неплохо описывает данные, остатки в основном соответствуют нормальному распределению, как показали Q-Q Plot и гистограмма. Однако есть небольшие отклонения в хвостах распределения.

Основные проблемы:

1) Гетероскедастичность: Веерообразная структура на графике остатков указывает на увеличение дисперсии остатков с ростом предсказанных значений. Это нарушение предположений линейной регрессии.
2) Влияние отдельных наблюдений: Несколько точек на графике 𝐷Кука могут быть потенциально влиятельными и существенно влиять на параметры модели. Их следует детально проанализировать.

## Сравнение моделей с и без ковариат

```{r}
# Сравнение моделей по AIC и BIC
AIC(model_without_covariates, model_with_covariates)
BIC(model_without_covariates, model_with_covariates)

# Тест на вклад ковариат
anova(model_without_covariates, model_with_covariates)
```

Интепретация: Результаты сравнения моделей с использованием AIC, BIC и ANOVA показывают, что модель с ковариатами лучше модели без ковариат.

1) Модель с ковариатами имеет меньший AIC (767.5222 против 897.9588), что указывает на её лучшее качество.

2) BIC также меньше для модели с ковариатами (897.0332 против 911.8350), что подтверждает лучший фит модели с ковариатами.

3) По результатам ANOVA, Residual Sum of Squares (RSS): Модель с ковариатами имеет меньший RSS (113.43 против 144.10), что означает, что она лучше объясняет вариацию данных.

4) F-тест: Значение F-статистики (7.8623) и p-значение (< 2.2e-16) показывают, что добавление ковариат значительно улучшает модель:
Нулевая гипотеза (H₀): Модель без ковариат так же хороша, как модель с ковариатами.
Альтернативная гипотеза (H₁): Модель с ковариатами лучше.
Поскольку p-значение < 0.001, мы отвергаем H₀ и принимаем H₁.

## Интерпретация результатов

```{r}
# Извлечение коэффициентов модели
model_summary <- tidy(model_with_covariates, conf.int = TRUE)  # Извлекаем коэффициенты с доверительными интервалами
model_metrics <- glance(model_with_covariates)  # Извлекаем общие метрики модели

# Добавляем звездочки для обозначения уровня значимости
model_summary <- model_summary %>%
  mutate(significance = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.01 ~ "**",
    p.value < 0.05 ~ "*",
    TRUE ~ ""
  ),
  p.value = round(p.value, 4))

# Объединяем коэффициенты и метрики в одну таблицу
final_table <- model_summary %>%
  dplyr:: select(term, estimate, std.error, statistic, p.value, conf.low, conf.high, significance) %>%
  rename(
    "Переменная" = term,
    "Коэффициент (β)" = estimate,
    "Стандартная ошибка (SE)" = std.error,
    "t-значение" = statistic,
    "p-значение" = p.value,
    "Нижний ДИ" = conf.low,
    "Верхний ДИ" = conf.high,
    "Значимость" = significance
  )

# Добавляем общие метрики модели
final_table <- final_table %>%
  bind_rows(
    tibble(
      Переменная = "R²",
      `Коэффициент (β)` = model_metrics$r.squared,
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    ),
    tibble(
      Переменная = "Скорректированный R²",
      `Коэффициент (β)` = model_metrics$adj.r.squared,
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    ),
    tibble(
      Переменная = "AIC",
      `Коэффициент (β)` = model_metrics$AIC,
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    ),
    tibble(
      Переменная = "BIC",
      `Коэффициент (β)` = model_metrics$BIC,
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    ),
    tibble(
      Переменная = "Логарифм правдоподобия",
      `Коэффициент (β)` = model_metrics$logLik,
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    ),
    tibble(
      Переменная = "RMSE",
      `Коэффициент (β)` = sqrt(model_metrics$sigma^2),
      `Стандартная ошибка (SE)` = NA,
      `t-значение` = NA,
      `p-значение` = NA,
      `Нижний ДИ` = NA,
      `Верхний ДИ` = NA,
      Значимость = ""
    )
  )

# Форматирование таблицы с помощью kableExtra
final_table %>%
  kable("html", digits = 3, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Коэффициенты" = 2, "Статистика" = 2, "Доверительные интервалы" = 2, " " = 1)) %>%
  row_spec(which(final_table$`p-значение` < 0.05), bold = TRUE, color = "black", background = "#E6F3FF") %>%
  footnote(general = "*** p < 0.001, ** p < 0.01, * p < 0.05", general_title = "Уровни значимости:")

# Альтернативно: форматирование с помощью flextable
final_table %>%
  flextable() %>%
  set_header_labels(
    Переменная = "Переменная",
    `Коэффициент (β)` = "Коэффициент (β)",
    `Стандартная ошибка (SE)` = "Стандартная ошибка (SE)",
    `t-значение` = "t-значение",
    `p-значение` = "p-значение",
    `Нижний ДИ` = "Нижний ДИ",
    `Верхний ДИ` = "Верхний ДИ",
    Значимость = "Значимость"
  ) %>%
  add_header_row(
    values = c(" ", "Коэффициенты", "Статистика", "Доверительные интервалы", " "),
    colwidths = c(1, 2, 2, 2, 1)
  ) %>%
  bold(part = "header") %>%
  bg(part = "body", i = which(final_table$`p-значение` < 0.05), bg = "#E6F3FF") %>%
  add_footer_lines("*** p < 0.001, ** p < 0.01, * p < 0.05") %>%
  autofit()
```

Интерпретация: Следущие переменные и их уровни оказывали значимое влияние на гликированный гемоглобин (HbA1c):
1) Возраст (***) - связан с увеличением HbA1c на 0.0092%,

2) Сопутсвующие заболевания (*) - связан с увеличением HbA1c на 0.0688%,

3) Уровень образования 3 (**, High school graduate/GED or equivalent) - Уровень образования 3 связан с уменьшением HbA1c на 0.171%,

4) Уровень образования 4 (*, Some college or AA degree) - Уровень образования 4 связан с уменьшением HbA1c на 0.152%,

5) Уровень образования 5 (***, College graduate or above) - Уровень образования 5 связан с уменьшением HbA1c на 0.270%,

6) Расовая принадлежность 4 (**, Non-Hispanic Black) - связана с увеличением HbA1c на 0.151%,

7) Расовая принадлежность 6 (***, Non-Hispanic Asian) - связана с увеличением HbA1c на 0.203%,

8) Уровень курения 3 (*, Now smoke cigarettes? - Not at all) - связан с увеличением HbA1c на 0.0801%.

### Выводы:

Возраст  сопутсвующие заболевания, уровень образования, расовая принадлежность и курение оказывают влияние на гликемированный гемоглобин. Возраст и хронические заболевания часто связаны с ухудшением контроля уровня глюкозы. Более высокий уровень образования связан с уменьшением уровня HbA1c. Это может быть связано с лучшим доступом к информации о здоровье, более здоровым образом жизни и лучшим доступом к медицинским услугам. Некоторые расовые группы (неиспаноязычные чернокожие и азиаты) имеют более высокий уровень HbA1c. Это может быть связано с генетическими, социальными или экономическими факторами, которые требуют дальнейшего изучения. Неожиданно, некурящие имеют более высокий уровень HbA1c. Это может быть связано с другими факторами, такими как стресс или диета, которые не учитываются в модели.

# Задание 5

Представьте результаты оценки модели без ковариат и с ковариатами в виде точечной и интервальной оценки эффекта физической активности. Дайте им словесную интерпретацию. Какие выводы мы можем сделать, исходя из точечной оценки? А из интервальной? Как выдумаете, можно ли считать эффект клинически значимым? Если затрудняетесь с ответом, что бы вам помогло дать ответ на этот вопрос?

## Модель без ковариат

1) Точечная оценка эффекта физической активности: -5.249e-06% (p > 0.05)

2) Интервальная оценка эффекта физической активности: (-1.790751e-05%; 7.409151e-06%) - 95% ДИ

## Модель с ковариатами

1) Точечная оценка эффекта физической активности: 2.137e-06% (p > 0.05)
2) Интервальная оценка эффекта физической активности: (-0.000009898744%; 0.00001417363%) - 95% ДИ

## Интерпретация результатов

### Модель без ковариат

Точечная оценка: Эффект физической активности на уровень гликированного гемоглобина (HbA1c) равен -5.249e-06%. Это означает, что в данной модели физическая активность не оказывает значимого влияния на уровень HbA1c. (p.value = 0.416 > 0.05)

Интервальная оценка: 95% доверительный интервал (ДИ) для эффекта физической активности включает ноль (-1.861605e-05%; 9.029029e-06%). Это подтверждает, что эффект физической активности статистически незначим.

Вывод: Мы не можем отвергнуть нулевую гипотезу о том, что физическая активность не влияет на уровень HbA1c.

### Модель с ковариатами

Точечная оценка: Эффект физической активности на уровень HbA1c также равен 2.137e-06%. Это указывает на отсутствие значимого влияния физической активности на уровень HbA1c даже после учета ковариат.(p-value = 0.5746 > 0.05)

Интервальная оценка: 95% доверительный интервал (ДИ) для эффекта физической активности также включает ноль (-0.000009898744%; 0.00001417363%). Это подтверждает, что эффект физической активности остается статистически незначимым даже после учета других факторов.

Вывод: Мы не можем отвергнуть нулевую гипотезу о том, что физическая активность не влияет на уровень HbA1c, даже после учета возраста, сопутствующих заболеваний, уровня образования, дохода, расы, пола и курения.

## Клиническая значимость

### Точечная оценка

Эффект физической активности на уровень HbA1c равен 0.000% в обеих моделях. Это указывает на то, что физическая активность не оказывает клинически значимого влияния на уровень HbA1c.

### Интервальная оценка

95% доверительный интервал для эффекта физической активности включает ноль в обеих моделях. Это означает, что мы не можем исключить возможность отсутствия эффекта физической активности на уровень HbA1c.

Даже если бы эффект был ненулевым, его величина (в пределах доверительного интервала) настолько мала, что вряд ли имела бы клиническое значение.

### Вывод о клинической значимости

На основании представленных данных эффект физической активности на уровень HbA1c является клинически незначимым. Это связано с тем, что:

1) Точечная оценка эффекта равна нулю.

2) Доверительный интервал включает ноль и имеет очень узкий диапазон, что указывает на отсутствие значимого влияния.

## Что могло бы помочь дать более точный ответ?

1) Дополнительные данные:

Если бы у нас были данные о более интенсивных или специфических видах физической активности, это могло бы помочь выявить возможные эффекты.

Данные о длительности и регулярности физической активности также могли бы быть полезны.

2) Более крупная выборка:

Увеличение размера выборки могло бы повысить мощность анализа и позволить выявить небольшие, но клинически значимые эффекты.

3) Учет дополнительных факторов:

Включение других переменных, таких как диета, уровень стресса или прием лекарств, могло бы помочь лучше объяснить вариацию уровня HbA1c.

4) Использование нелинейных моделей:

Возможно, эффект физической активности нелинеен. Например, только высокие уровни активности могут оказывать влияние на HbA1c. Это можно проверить с помощью нелинейных моделей.

5) Долгосрочные данные:

Если бы у нас были данные за более длительный период, это могло бы помочь выявить кумулятивный эффект физической активности на уровень HbA1c.

## Итоговый вывод

На основании представленных результатов:

1) Физическая активность не оказывает статистически значимого влияния на уровень гликированного гемоглобина (HbA1c) как в модели без ковариат, так и в модели с ковариатами.

2) Эффект физической активности является клинически незначимым, так как точечная оценка равна нулю, а доверительный интервал включает ноль.

3) Для более точного ответа на вопрос о клинической значимости необходимы дополнительные данные, включая информацию о интенсивности, длительности и регулярности физической активности, а также учет других факторов, влияющих на уровень HbA1c.

# Задание 6

Проверьте гипотезу об отсутствии ассоциации между физической активностью и гликированным гемоглобином. Сделайте выводы по полученным результатам.

## ANOVA

Можно разделить данные на группы по уровню физической активности (например, низкая, умеренная, высокая) и сравнить средние уровни HbA1c между группами.

Нулевая гипотеза (H0): Средние значения зависимой переменной одинаковы для всех групп.
Альтернативная гипотеза (HA): Средние значения зависимой переменной хотя бы в одной группе отличаются.

```{r}

anova_result <- aov(gHg ~ PA_category, data = main_data)
summary(anova_result) 

```
Интерпретация: нет статистически значимых различий в зависимости переменной gHg между категориями физической активности (высокая, низкая, умеренная).  В принципе эксплораторный анализ (Задание 3) - визуализация уровня гликированного гемоглобина по группам физической активности показал аналогичные результаты.

## Kruskal-Wallis test

Если данные не нормальны, используем непараметрический тест Краскела-Уоллиса.

Нулевая гипотеза (H0): Распределение значений зависимой переменной одинаково во всех группах.
Альтернативная гипотеза (HA): Распределения значений хотя бы в одной группе отличаются.

```{r}

kruskal_test <- kruskal.test(gHg ~ PA_category, data = main_data)
print(kruskal_test)

```
P-значение > 0.05, различия между группами незначимы.

## Тест Кендалла (Kendall's tau)

Тест менее чувствителен к выбросам.

Нулевая гипотеза (H0): Между двумя переменными нет зависимости.
Альтернативная гипотеза (HA): Между двумя переменными существует зависимость.

```{r}

kendall_test <- cor.test(main_data$gHg, main_data$total_PA, method = "kendall")
print(kendall_test)

```
P-значение = 0.5035 > 0.05 указывает на отсутствие значимой связи.

## Корреляционный анализ 

Для проверки гипотезы об отсутствии ассоциации между физической активностью и гликированным гемоглобином (HbA1c) можно использовать как корреляционный анализ.

Нулевая гипотеза (H₀): Корреляция между физической активностью и уровнем гликированного гемоглобина равна нулю.

Альтернативная гипотеза (H₁): Корреляция между физической активностью и уровнем гликированного гемоглобина не равна нулю.

```{r}

cor_test_result <- cor.test(main_data$gHg, main_data$total_PA, method = "pearson")
print(cor_test_result)

```

Интерпретация: Корреляция между gHg и total_PA очень слабая и статистически не значима (𝑝> 0.05). Нет достаточных доказательств линейной зависимости между этими переменными.

### Выводы: 
по результатам ANOVA, теста, Краскелла-Уоллиса, Кендалла и Пирсона не выявлена ассоциации между физической активностью и гликированным гемоглобином.

# Задание 7

Является ли пол модификатором эффекта физической активности в отношении гликированного гемоглобина? Если да, каков эффект для мужчин и женщин и насколько он отличается между ними?

## Построение модели с взаимодействием

Для проверки модифицирующего эффекта пола добавим взаимодействие между total_PA и Sex в модель.

```{r}

model_interaction <- lm(gHg ~ total_PA * Sex, data = main_data)
summary(model_interaction)

```

Модифицирующий эффект пола:
Взаимодействие между полом (Sex) и физической активностью (total_PA) не является статистически значимым (p=0.0712). Это означает, что нет достаточных доказательств того, что пол существенно изменяет эффект физической активности на уровень гликированного гемоглобина.

Однако вопросы к качеству модели: Multiple R-squared=0.0151, Adjusted R-squared= 0.01116. Модель объясняет лишь ∼1.12% вариации в данных, что указывает на слабую объясняющую способность модели. Модель в целом статистически значима, но, по результатам построения, взаимодействие между физической активностью и полом не является ключевым фактором.

## Проверка значимости взаимодействия

Чтобы проверить, является ли взаимодействие между полом и физической активностью значимым, можно использовать ANOVA для сравнения модели с взаимодействием и модели без взаимодействия.

```{r}

model_no_interaction <- lm(gHg ~ total_PA, data = main_data)
anova(model_no_interaction, model_interaction)

```
p-значение для взаимодействия (Pr(>F)) равно 0.004635, что может указывать на различный эффект физической активности на gHg между мужчинами и женщинами.

# Задание 8 

Соответствуют ли полученные вами результаты вашему исходному предположению? Как меняется оценка эффекта физической активности при добавлении ковариат в модель и почему?

Результаты исследования не подтвердили предположение о значимом эффекте физической активности на уровень гликированного гемоглобина, так как гипотезу о наличии статистически значимых различий между уровнями физической активности (высокий, низкий, умеренный) отвергнуть не удалось. Включение пола как модификатора эффекта физической активности на уровень гликированного гемоглобина также не выявило статистически значимых взаимодействий. В моделях как с ковариатами, так и без, p-value не позволял отвергнуть нулевую гипотезу об отсутвии физ активнсоти на уровень гликированного гемоглобина. В модели с ковариатами точечная оченка меняется на положительную (отрицательная в модели без), однако и в том и в другом случае ДИ 95% включает ноль.
