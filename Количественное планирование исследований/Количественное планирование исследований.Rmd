---
title: 'Количественное планирование исследований'
author: "Sergey"
date: "2025-01-17"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(conflicted)
library(TrialSize)
library(epiR)
conflicts_prefer(dplyr::filter())
conflicts_prefer(dplyr::lag())
```

# Количественное планирование исследований

## Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении ХОБЛ

Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите.
Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял 7.2 ± 3.1%. Предлагаемая граница не меньшей эффективности – 2 %.

Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим образом:

H0: T - R <= δ
HA T - R > δ,

где
T – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии для препарата T;
R – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии для препарата R; 
δ – граница не меньшей эффективности.

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Из литературных данных известно, что для референтного препарата R абсолютный прирост индекса Тиффно за 3 месяца в среднем (M±SD) составляет 7.2 ± 3.1%. Для исследуемого препарата T абсолютный прирост индекса Тиффно ожидается на том же уровне.
2. Предлагаемая граница не меньшей эффективности – 2 %.
3. Для обеспечения достаточной чувствительности исследования его мощность должна быть установлена на уровне 80%, что означает, что допустимая вероятность ошибки II рода (β) составит 0,2.
4. Распределение в группы будет равномерным в соотношении 1:1;
5. Односторонняя величина ошибки I рода (α) составляет 0.025;

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.1) с помощью функции epi.ssninfc из пакета epiR (версия 2.0.74).

Результаты расчёта представлены далее.

```{r}
epi.ssninfc(
    treat = 7.2,
    control = 7.2,
    sigma = 3.1,
    delta = 2,
    n = NA,
    power = 0.8, 
    r = 1,
    nfractional = FALSE,
    alpha = 0.025
)
#?epi.ssninfc
```
Интерпретация: По результатам расчёта, всего необходимо 76 пациентов, по 38 на кажду группу - контроля и испытуемую. С учетом возможного выбывания 20% пациентов в ходе исследования, в каждую группу необходимо включить не менее 48 человек, а общее количество пациентов должно быть не менее 95.
Дополнительно, с учетом выбывания 10% пациентов на этапе скрининга, в каждую группу нужно включить не менее 54 пациента, что в сумме составит не менее 108 человек.

## Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза.

Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%, при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1%. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:

H0: T - R =< δ 
HA: T - R > δ

T – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ для препарата T;
R – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ препарата R; 
δ – граница превосходства 1%.

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15%.
2. Cпонсор хотел бы, чтобы граница превосходства была бы равна 1%.
3. Для обеспечения достаточной чувствительности исследования его мощность должна быть установлена на уровне 80%, что означает, что допустимая вероятность ошибки II рода (β) составит 0,2.
4. Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.
5. Односторонняя величина ошибки I рода (α) составляет 0.025;

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.1) с помощью функции epi.sssupb из пакета epiR (версия 2.0.74).
 
Результаты расчёта представлены далее.

```{r pressure, echo=FALSE}
epi.sssupb(
    treat = 0.81,
    control = 0.66,
    delta = 1,
    n = NA,
    power = 0.8,
    r = 2,
    nfractional = FALSE,
    alpha = 0.025
)
```

Интерпретация: По результатам расчёта всего необходимо 12 пациентов, при этом в группу лечения должны войти 8 пациентов, а в контрольную - 4 пациента. С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в группу лечения необходимо набрать не менее 10 человек, в контрольную - 5. В скрининг (с учётом 10% выбывания) необходимо включить не менее 11 пациентов в группу лечения, в контрольную - 6.

## Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений.

Первичная конечная точка – объём кровопотери в мл. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

H0: T - R >= δ
HA: T - R < δ

T – объём кровопотери в мл при применении препарата A;
R – объём кровопотери в мл при применении препарата Б;  
δ – граница превосходства - 50 мл.

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б - 244.8 мл.
2. Границу превосходства предполагается установить равной 50 мл.
3. Для обеспечения достаточной чувствительности исследования его мощность должна быть установлена на уровне 80%, что означает, что допустимая вероятность ошибки II рода (β) составит 0,2.
4. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.
5. Односторонняя величина ошибки I рода (α) составляет 0.025;

Расчёт размера выборки был проведён в RStudio** (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.1) с помощью функции TwoSampleMean.NIS из пакета TrialSize (версия 1.4).

```{r}
T <- TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 52,
    k = 3, #k=n1/n2, 0.75 = 3/4 => 1 to 3 test-control allocation
    delta = -50,
    margin = -61.2 #244,8-306
)
print(T)
R <- round(T/3, 0)
print(R)
#?TwoSampleMean.NIS
```
По результатам расчёта, в группу лечения требуется включить минимум 677 пациентов, а в контрольную группу — не менее 226 пациентов.  
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в группу лечения необходимо включить не менее 847 пациентов, а в контрольную группу — не менее 252 пациента.  
В скрининг (с учётом 10% выбывания) необходимо в группу лечения нужно включить не менее 942 пациента, а в контрольную группу — не менее 280 пациентов.

## Исследование превосходства препарата У над препаратом Х в лечении рецидивирующего псориатического артрита

Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15%. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%. При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования.

Статистическая гипотеза превосходства в исследовании была сформулирована следующим
образом:

H0: T - R >= δ 
HA: T - R < δ

T – частота рецидивов псориатического артрита за 6 месяцев при лечении препаратом Y;
R – частота рецидивов псориатического артрита за 6 месяцев при лечении препаратом X;
δ – граница превосходства.

При расчёте необходимого размера выборки были сделаны следующие допущения:

1. Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев. Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15% - до 17% случаев.
2. Границей превосходства можно считать снижение доли пациентов с рецидивом более, чем на 5%.
3. Для обеспечения достаточной чувствительности исследования его мощность должна быть установлена на уровне 80%, что означает, что допустимая вероятность ошибки II рода (β) составит 0,2.
4. Существует ограничение по количеству препарата (пациенты в испытуемой группе) - препарат Х должны получить не более 250 пациентов включённых в исследование. 
5. Односторонняя величина ошибки I рода (α) составляет 0.025;

Расчёт размера выборки был проведён в RStudio (версия 2024.12.0 Build 467) c использованием языка R (версия 4.4.1) с помощью функции epi.sssupb из пакета epiR (версия 2.0.74).

```{r}
epi.sssupb(
    treat = 0.17,
    control = 0.32,
    delta = 0.05,
    alpha = 0.025,
    power = 0.8,
    r = 1,
    n = NA
)
r <- 1
max_control <- 250
n_control <- max_control
n_treat <- n_control / r
#?epi.sssupb
```
По результатам расчёта в испытуемую группу необходимо минимум 71 (с учётом ограничения по количеству препарата - 180) человек, а в контрольную - 71. 
С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в группу лечения необходимо включить не менее 89 пациентов, а в контрольную группу - не менее 89 пациентов.   
человек. В скрининг (с учётом 10% выбывания) необходимо в группу лечения включить не менее 99 пациентов, а в контрольную группу - не менее 99 пациентов.  
